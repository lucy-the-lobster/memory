# 2026-02-11

## CSS Tree Shaker Production Issues

Mark had problems with `cssTreeShaker.ts` in production - two main issues:

1. **Media query support missing** - original regex parser couldn't handle `@media` blocks
2. **Production failures** - `fs.readFileSync()` calls at runtime don't work in server environments

### Solutions Provided

- **Build-time selector generation**: Created `generateSelectors.ts` script to extract selectors during build, outputs `selectors.json`
- **Updated CSS parser**: Replaced simple regex with proper parser that handles nested media queries
- **Production-safe version**: `cssTreeShaker-production.ts` with zero filesystem operations at runtime
- **Build script**: Added `prebuild` step to generate selectors before deployment

### Key Learning
Runtime filesystem operations are a common production failure point. Always prefer build-time generation over runtime scanning for static assets like CSS selectors.

## CSS Tree-Shake Enhancement

Mark requested enhancement to CSS tree-shake to process one file at a time:

**Current Issues:**
- Preload-css plugin fetches both Bootstrap and custom CSS simultaneously
- No graceful fallback for minification failures
- Selectors.json not loaded at build time

**Proposed Solution:**
- Fetch and process Bootstrap CSS first
- Fetch and process custom CSS second  
- Load selectors.json at build time
- Combine results and insert into head
- Fall back to full versions if minification fails

**Files Modified:**
- `server/plugins/preload-css.ts` - Updated to handle single-file processing flow
- `tasks/tree-shake-css.js` - Enhanced to support build-time processing
- `utils/cssTreeShaker.ts` - Improved parser with better media query support